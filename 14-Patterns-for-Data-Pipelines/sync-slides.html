<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="generator" content="pandoc">
  <meta name="author" content="Week 14 - sync session">
  <title>Fundamentals of Data Engineering</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
  <link rel="stylesheet" href="reveal.js/css/reveal.css">
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; position: absolute; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; }
pre.numberSource a.sourceLine:empty
  { position: absolute; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: absolute; left: -5em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="reveal.js/css/theme/mids.css" id="theme">
  <!-- Printing and PDF exports -->
  <script>
    var link = document.createElement( 'link' );
    link.rel = 'stylesheet';
    link.type = 'text/css';
    link.href = window.location.search.match( /print-pdf/gi ) ? 'reveal.js/css/print/pdf.css' : 'reveal.js/css/print/paper.css';
    document.getElementsByTagName( 'head' )[0].appendChild( link );
  </script>
  <!--[if lt IE 9]>
  <script src="reveal.js/lib/js/html5shiv.js"></script>
  <![endif]-->
</head>
<body>
  <div class="reveal">
    <div class="slides">

<section>
  <h1 class="title">Fundamentals of Data Engineering</h1>
  <h2 class="author">Week 14 - sync session</h2>
  <img class="frontPageSlogan" src="http://people.ischool.berkeley.edu/~mark.mims/course-development/2017-mids-w205/media/datascience-at-berkeley.png"/>
</section>

<section id="section" class="slide level1">
<h1></h1>
<section id="get-started" class="level2">
<h2>Get Started</h2>
<pre><code>git pull in ~/w205/course-content
mkdir ~/w205/full-streaming-stack/
cd ~/w205/full-streaming-stack
cp ~/w205/course-content/14-Patterns-for-Data-Pipelines/docker-compose.yml .
docker-compose pull
cp ~/w205/course-content/14-Patterns-for-Data-Pipelines/*.py .
</code></pre>
<aside class="notes">

</aside>
</section>
</section>
<section id="section-1" class="slide level1">
<h1></h1>
<section id="announcements" class="level2">
<h2>Announcements</h2>
<ul>
<li>repos - fork or clone your repos by 27Apr2018</li>
<li>future - <code>course-content</code> tagged by semester</li>
</ul>
<aside class="notes">
<ul>
<li>Youâ€™ll maintain access to <code>mids-w205-&lt;instructor&gt;/course-content</code></li>
<li>This semester will be tagged <code>spring2018</code></li>
<li>Explain will add read access for main course content (fund of data eng)</li>
<li>Explain tagging</li>
<li>Will have access to the version you had + updates for the future</li>
</ul>
</aside>
</section>
</section>
<section id="section-2" class="slide level1">
<h1></h1>
<section id="section-3" class="level2" data-background="images/pipeline-steel-thread-for-mobile-app.svg">
<h2></h2>
<aside class="notes">
<p>review pipeline summary</p>
</aside>
</section>
</section>
<section id="section-4" class="slide level1">
<h1></h1>
<section id="full-stack-streaming" class="level2">
<h2>Full-Stack Streaming</h2>
<aside class="notes">
<ul>
<li>last week we introduced Presto and Spark Streaming</li>
<li>Set up tmux session to have a pane for each service</li>
</ul>
</aside>
</section>
</section>
<section id="section-5" class="slide level1">
<h1></h1>
<section id="setup" class="level2">
<h2>Setup</h2>
</section>
<section id="the-docker-compose.yml" class="level2">
<h2>The <code>docker-compose.yml</code></h2>
<p>Create a <code>docker-compose.yml</code> with the following</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode yml"><code class="sourceCode yaml"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="ot">---</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="fu">version:</span><span class="at"> </span><span class="st">&#39;2&#39;</span></a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="fu">services:</span></a>
<a class="sourceLine" id="cb2-4" data-line-number="4">  <span class="fu">zookeeper:</span></a>
<a class="sourceLine" id="cb2-5" data-line-number="5">    <span class="fu">image:</span><span class="at"> confluentinc/cp-zookeeper:latest</span></a>
<a class="sourceLine" id="cb2-6" data-line-number="6">    <span class="fu">environment:</span></a>
<a class="sourceLine" id="cb2-7" data-line-number="7">      <span class="fu">ZOOKEEPER_CLIENT_PORT:</span><span class="at"> 32181</span></a>
<a class="sourceLine" id="cb2-8" data-line-number="8">      <span class="fu">ZOOKEEPER_TICK_TIME:</span><span class="at"> 2000</span></a>
<a class="sourceLine" id="cb2-9" data-line-number="9">    <span class="fu">expose:</span></a>
<a class="sourceLine" id="cb2-10" data-line-number="10">      <span class="kw">-</span> <span class="st">&quot;2181&quot;</span></a>
<a class="sourceLine" id="cb2-11" data-line-number="11">      <span class="kw">-</span> <span class="st">&quot;2888&quot;</span></a>
<a class="sourceLine" id="cb2-12" data-line-number="12">      <span class="kw">-</span> <span class="st">&quot;32181&quot;</span></a>
<a class="sourceLine" id="cb2-13" data-line-number="13">      <span class="kw">-</span> <span class="st">&quot;3888&quot;</span></a>
<a class="sourceLine" id="cb2-14" data-line-number="14">    <span class="fu">extra_hosts:</span></a>
<a class="sourceLine" id="cb2-15" data-line-number="15">      <span class="kw">-</span> <span class="st">&quot;moby:127.0.0.1&quot;</span></a>
<a class="sourceLine" id="cb2-16" data-line-number="16"></a>
<a class="sourceLine" id="cb2-17" data-line-number="17">  <span class="fu">kafka:</span></a>
<a class="sourceLine" id="cb2-18" data-line-number="18">    <span class="fu">image:</span><span class="at"> confluentinc/cp-kafka:latest</span></a>
<a class="sourceLine" id="cb2-19" data-line-number="19">    <span class="fu">depends_on:</span></a>
<a class="sourceLine" id="cb2-20" data-line-number="20">      <span class="kw">-</span> zookeeper</a>
<a class="sourceLine" id="cb2-21" data-line-number="21">    <span class="fu">environment:</span></a>
<a class="sourceLine" id="cb2-22" data-line-number="22">      <span class="fu">KAFKA_BROKER_ID:</span><span class="at"> 1</span></a>
<a class="sourceLine" id="cb2-23" data-line-number="23">      <span class="fu">KAFKA_ZOOKEEPER_CONNECT:</span><span class="at"> zookeeper:32181</span></a>
<a class="sourceLine" id="cb2-24" data-line-number="24">      <span class="fu">KAFKA_ADVERTISED_LISTENERS:</span><span class="at"> PLAINTEXT://kafka:29092</span></a>
<a class="sourceLine" id="cb2-25" data-line-number="25">      <span class="fu">KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR:</span><span class="at"> 1</span></a>
<a class="sourceLine" id="cb2-26" data-line-number="26">    <span class="fu">expose:</span></a>
<a class="sourceLine" id="cb2-27" data-line-number="27">      <span class="kw">-</span> <span class="st">&quot;9092&quot;</span></a>
<a class="sourceLine" id="cb2-28" data-line-number="28">      <span class="kw">-</span> <span class="st">&quot;29092&quot;</span></a>
<a class="sourceLine" id="cb2-29" data-line-number="29">    <span class="fu">extra_hosts:</span></a>
<a class="sourceLine" id="cb2-30" data-line-number="30">      <span class="kw">-</span> <span class="st">&quot;moby:127.0.0.1&quot;</span></a>
<a class="sourceLine" id="cb2-31" data-line-number="31"></a>
<a class="sourceLine" id="cb2-32" data-line-number="32">  <span class="fu">cloudera:</span></a>
<a class="sourceLine" id="cb2-33" data-line-number="33">    <span class="fu">image:</span><span class="at"> midsw205/hadoop:0.0.2</span></a>
<a class="sourceLine" id="cb2-34" data-line-number="34">    <span class="fu">hostname:</span><span class="at"> cloudera</span></a>
<a class="sourceLine" id="cb2-35" data-line-number="35">    <span class="fu">expose:</span></a>
<a class="sourceLine" id="cb2-36" data-line-number="36">      <span class="kw">-</span> <span class="st">&quot;8020&quot;</span> <span class="co"># nn</span></a>
<a class="sourceLine" id="cb2-37" data-line-number="37">      <span class="kw">-</span> <span class="st">&quot;8888&quot;</span> <span class="co"># hue</span></a>
<a class="sourceLine" id="cb2-38" data-line-number="38">      <span class="kw">-</span> <span class="st">&quot;9083&quot;</span> <span class="co"># hive thrift</span></a>
<a class="sourceLine" id="cb2-39" data-line-number="39">      <span class="kw">-</span> <span class="st">&quot;10000&quot;</span> <span class="co"># hive jdbc</span></a>
<a class="sourceLine" id="cb2-40" data-line-number="40">      <span class="kw">-</span> <span class="st">&quot;50070&quot;</span> <span class="co"># nn http</span></a>
<a class="sourceLine" id="cb2-41" data-line-number="41">    <span class="fu">ports:</span></a>
<a class="sourceLine" id="cb2-42" data-line-number="42">      <span class="kw">-</span> <span class="st">&quot;8888:8888&quot;</span></a>
<a class="sourceLine" id="cb2-43" data-line-number="43">    <span class="fu">extra_hosts:</span></a>
<a class="sourceLine" id="cb2-44" data-line-number="44">      <span class="kw">-</span> <span class="st">&quot;moby:127.0.0.1&quot;</span></a>
<a class="sourceLine" id="cb2-45" data-line-number="45"></a>
<a class="sourceLine" id="cb2-46" data-line-number="46">  <span class="fu">spark:</span></a>
<a class="sourceLine" id="cb2-47" data-line-number="47">    <span class="fu">image:</span><span class="at"> midsw205/spark-python:0.0.6</span></a>
<a class="sourceLine" id="cb2-48" data-line-number="48">    <span class="fu">stdin_open:</span><span class="at"> true</span></a>
<a class="sourceLine" id="cb2-49" data-line-number="49">    <span class="fu">tty:</span><span class="at"> true</span></a>
<a class="sourceLine" id="cb2-50" data-line-number="50">    <span class="fu">volumes:</span></a>
<a class="sourceLine" id="cb2-51" data-line-number="51">      <span class="kw">-</span> <span class="fu">~/w205:</span><span class="at">/w205</span></a>
<a class="sourceLine" id="cb2-52" data-line-number="52">    <span class="fu">expose:</span></a>
<a class="sourceLine" id="cb2-53" data-line-number="53">      <span class="kw">-</span> <span class="st">&quot;8888&quot;</span></a>
<a class="sourceLine" id="cb2-54" data-line-number="54">    <span class="fu">ports:</span></a>
<a class="sourceLine" id="cb2-55" data-line-number="55">      <span class="kw">-</span> <span class="st">&quot;8889:8888&quot;</span> <span class="co"># 8888 conflicts with hue</span></a>
<a class="sourceLine" id="cb2-56" data-line-number="56">    <span class="fu">depends_on:</span></a>
<a class="sourceLine" id="cb2-57" data-line-number="57">      <span class="kw">-</span> cloudera</a>
<a class="sourceLine" id="cb2-58" data-line-number="58">    <span class="fu">environment:</span></a>
<a class="sourceLine" id="cb2-59" data-line-number="59">      <span class="fu">HADOOP_NAMENODE:</span><span class="at"> cloudera</span></a>
<a class="sourceLine" id="cb2-60" data-line-number="60">      <span class="fu">HIVE_THRIFTSERVER:</span><span class="at"> cloudera:9083</span></a>
<a class="sourceLine" id="cb2-61" data-line-number="61">    <span class="fu">extra_hosts:</span></a>
<a class="sourceLine" id="cb2-62" data-line-number="62">      <span class="kw">-</span> <span class="st">&quot;moby:127.0.0.1&quot;</span></a>
<a class="sourceLine" id="cb2-63" data-line-number="63">    <span class="fu">command:</span><span class="at"> bash</span></a>
<a class="sourceLine" id="cb2-64" data-line-number="64"></a>
<a class="sourceLine" id="cb2-65" data-line-number="65">  <span class="fu">presto:</span></a>
<a class="sourceLine" id="cb2-66" data-line-number="66">    <span class="fu">image:</span><span class="at"> midsw205/presto:0.0.1</span></a>
<a class="sourceLine" id="cb2-67" data-line-number="67">    <span class="fu">hostname:</span><span class="at"> presto</span></a>
<a class="sourceLine" id="cb2-68" data-line-number="68">    <span class="fu">volumes:</span></a>
<a class="sourceLine" id="cb2-69" data-line-number="69">      <span class="kw">-</span> <span class="fu">~/w205:</span><span class="at">/w205</span></a>
<a class="sourceLine" id="cb2-70" data-line-number="70">    <span class="fu">expose:</span></a>
<a class="sourceLine" id="cb2-71" data-line-number="71">      <span class="kw">-</span> <span class="st">&quot;8080&quot;</span></a>
<a class="sourceLine" id="cb2-72" data-line-number="72">    <span class="fu">environment:</span></a>
<a class="sourceLine" id="cb2-73" data-line-number="73">      <span class="fu">HIVE_THRIFTSERVER:</span><span class="at"> cloudera:9083</span></a>
<a class="sourceLine" id="cb2-74" data-line-number="74">    <span class="fu">extra_hosts:</span></a>
<a class="sourceLine" id="cb2-75" data-line-number="75">      <span class="kw">-</span> <span class="st">&quot;moby:127.0.0.1&quot;</span></a>
<a class="sourceLine" id="cb2-76" data-line-number="76"></a>
<a class="sourceLine" id="cb2-77" data-line-number="77">  <span class="fu">mids:</span></a>
<a class="sourceLine" id="cb2-78" data-line-number="78">    <span class="fu">image:</span><span class="at"> midsw205/base:0.1.9</span></a>
<a class="sourceLine" id="cb2-79" data-line-number="79">    <span class="fu">stdin_open:</span><span class="at"> true</span></a>
<a class="sourceLine" id="cb2-80" data-line-number="80">    <span class="fu">tty:</span><span class="at"> true</span></a>
<a class="sourceLine" id="cb2-81" data-line-number="81">    <span class="fu">volumes:</span></a>
<a class="sourceLine" id="cb2-82" data-line-number="82">      <span class="kw">-</span> <span class="fu">~/w205:</span><span class="at">/w205</span></a>
<a class="sourceLine" id="cb2-83" data-line-number="83">    <span class="fu">expose:</span></a>
<a class="sourceLine" id="cb2-84" data-line-number="84">      <span class="kw">-</span> <span class="st">&quot;5000&quot;</span></a>
<a class="sourceLine" id="cb2-85" data-line-number="85">    <span class="fu">ports:</span></a>
<a class="sourceLine" id="cb2-86" data-line-number="86">      <span class="kw">-</span> <span class="st">&quot;5000:5000&quot;</span></a>
<a class="sourceLine" id="cb2-87" data-line-number="87">    <span class="fu">extra_hosts:</span></a>
<a class="sourceLine" id="cb2-88" data-line-number="88">      <span class="kw">-</span> <span class="st">&quot;moby:127.0.0.1&quot;</span></a></code></pre></div>
<aside class="notes">
<p>same as last week.. except for a port mapping to expose jupyter notebooks from the spark container</p>
</aside>
</section>
<section id="spin-up-the-cluster" class="level2">
<h2>Spin up the cluster</h2>
<pre><code>docker-compose up -d</code></pre>
<aside class="notes">
<ul>
<li>Now spin up the cluster</li>
</ul>
<pre><code>docker-compose up -d</code></pre>
<ul>
<li>Notice we didnâ€™t actually create a topic as the broker does this for you</li>
</ul>
</aside>
</section>
<section id="web-app" class="level2">
<h2>Web-app</h2>
<ul>
<li>Take our instrumented web-app from before <code>~/w205/full-streaming-stack/game_api.py</code></li>
</ul>
<div class="sourceCode" id="cb5"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="co">#!/usr/bin/env python</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2"><span class="im">import</span> json</a>
<a class="sourceLine" id="cb5-3" data-line-number="3"><span class="im">from</span> kafka <span class="im">import</span> KafkaProducer</a>
<a class="sourceLine" id="cb5-4" data-line-number="4"><span class="im">from</span> flask <span class="im">import</span> Flask, request</a>
<a class="sourceLine" id="cb5-5" data-line-number="5"></a>
<a class="sourceLine" id="cb5-6" data-line-number="6">app <span class="op">=</span> Flask(<span class="va">__name__</span>)</a>
<a class="sourceLine" id="cb5-7" data-line-number="7">producer <span class="op">=</span> KafkaProducer(bootstrap_servers<span class="op">=</span><span class="st">&#39;kafka:29092&#39;</span>)</a>
<a class="sourceLine" id="cb5-8" data-line-number="8"></a>
<a class="sourceLine" id="cb5-9" data-line-number="9"></a>
<a class="sourceLine" id="cb5-10" data-line-number="10"><span class="kw">def</span> log_to_kafka(topic, event):</a>
<a class="sourceLine" id="cb5-11" data-line-number="11">    event.update(request.headers)</a>
<a class="sourceLine" id="cb5-12" data-line-number="12">    producer.send(topic, json.dumps(event).encode())</a>
<a class="sourceLine" id="cb5-13" data-line-number="13"></a>
<a class="sourceLine" id="cb5-14" data-line-number="14"></a>
<a class="sourceLine" id="cb5-15" data-line-number="15"><span class="at">@app.route</span>(<span class="st">&quot;/&quot;</span>)</a>
<a class="sourceLine" id="cb5-16" data-line-number="16"><span class="kw">def</span> default_response():</a>
<a class="sourceLine" id="cb5-17" data-line-number="17">    default_event <span class="op">=</span> {<span class="st">&#39;event_type&#39;</span>: <span class="st">&#39;default&#39;</span>}</a>
<a class="sourceLine" id="cb5-18" data-line-number="18">    log_to_kafka(<span class="st">&#39;events&#39;</span>, default_event)</a>
<a class="sourceLine" id="cb5-19" data-line-number="19">    <span class="cf">return</span> <span class="st">&quot;This is the default response!</span><span class="ch">\n</span><span class="st">&quot;</span></a>
<a class="sourceLine" id="cb5-20" data-line-number="20"></a>
<a class="sourceLine" id="cb5-21" data-line-number="21"></a>
<a class="sourceLine" id="cb5-22" data-line-number="22"><span class="at">@app.route</span>(<span class="st">&quot;/purchase_a_sword&quot;</span>)</a>
<a class="sourceLine" id="cb5-23" data-line-number="23"><span class="kw">def</span> purchase_a_sword():</a>
<a class="sourceLine" id="cb5-24" data-line-number="24">    purchase_sword_event <span class="op">=</span> {<span class="st">&#39;event_type&#39;</span>: <span class="st">&#39;purchase_sword&#39;</span>}</a>
<a class="sourceLine" id="cb5-25" data-line-number="25">    log_to_kafka(<span class="st">&#39;events&#39;</span>, purchase_sword_event)</a>
<a class="sourceLine" id="cb5-26" data-line-number="26">    <span class="cf">return</span> <span class="st">&quot;Sword Purchased!</span><span class="ch">\n</span><span class="st">&quot;</span></a></code></pre></div>
<aside class="notes">
<ul>
<li>same web app as before</li>
</ul>
</aside>
</section>
<section id="run-flask" class="level2">
<h2>run flask</h2>
<pre><code>docker-compose exec mids \
  env FLASK_APP=/w205/full-streaming-stack/game_api.py \
  flask run --host 0.0.0.0</code></pre>
<aside class="notes">
<pre><code>docker-compose exec mids env FLASK_APP=/w205/full-streaming-stack/game_api.py flask run --host 0.0.0.0</code></pre>
</aside>
</section>
<section id="set-up-to-watch-kafka" class="level2">
<h2>Set up to watch kafka</h2>
<pre><code>docker-compose exec mids \
  kafkacat -C -b kafka:29092 -t events -o beginning</code></pre>
<aside class="notes">
<ul>
<li>new terminal window, leave up</li>
<li>running kafkacat without -e so it will run continuously</li>
<li>run this twice so itâ€™ll create the topic</li>
</ul>
<pre><code>docker-compose exec mids kafkacat -C -b kafka:29092 -t events -o beginning</code></pre>
</aside>
</section>
</section>
<section id="section-6" class="slide level1">
<h1></h1>
<section id="streaming" class="level2">
<h2>Streaming</h2>
</section>
<section id="section-7" class="level2">
<h2></h2>
<div class="sourceCode" id="cb10"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="co">#!/usr/bin/env python</span></a>
<a class="sourceLine" id="cb10-2" data-line-number="2"><span class="co">&quot;&quot;&quot;Extract events from kafka and write them to hdfs</span></a>
<a class="sourceLine" id="cb10-3" data-line-number="3"><span class="co">&quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb10-4" data-line-number="4"><span class="im">import</span> json</a>
<a class="sourceLine" id="cb10-5" data-line-number="5"><span class="im">from</span> pyspark.sql <span class="im">import</span> SparkSession</a>
<a class="sourceLine" id="cb10-6" data-line-number="6"><span class="im">from</span> pyspark.sql.functions <span class="im">import</span> udf, from_json</a>
<a class="sourceLine" id="cb10-7" data-line-number="7"><span class="im">from</span> pyspark.sql.types <span class="im">import</span> StructType, StructField, StringType</a>
<a class="sourceLine" id="cb10-8" data-line-number="8"></a>
<a class="sourceLine" id="cb10-9" data-line-number="9"></a>
<a class="sourceLine" id="cb10-10" data-line-number="10"><span class="kw">def</span> purchase_sword_event_schema():</a>
<a class="sourceLine" id="cb10-11" data-line-number="11">    <span class="co">&quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb10-12" data-line-number="12"><span class="co">    root</span></a>
<a class="sourceLine" id="cb10-13" data-line-number="13"><span class="co">    |-- Accept: string (nullable = true)</span></a>
<a class="sourceLine" id="cb10-14" data-line-number="14"><span class="co">    |-- Host: string (nullable = true)</span></a>
<a class="sourceLine" id="cb10-15" data-line-number="15"><span class="co">    |-- User-Agent: string (nullable = true)</span></a>
<a class="sourceLine" id="cb10-16" data-line-number="16"><span class="co">    |-- event_type: string (nullable = true)</span></a>
<a class="sourceLine" id="cb10-17" data-line-number="17"><span class="co">    &quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb10-18" data-line-number="18">    <span class="cf">return</span> StructType([</a>
<a class="sourceLine" id="cb10-19" data-line-number="19">        StructField(<span class="st">&quot;Accept&quot;</span>, StringType(), <span class="va">True</span>),</a>
<a class="sourceLine" id="cb10-20" data-line-number="20">        StructField(<span class="st">&quot;Host&quot;</span>, StringType(), <span class="va">True</span>),</a>
<a class="sourceLine" id="cb10-21" data-line-number="21">        StructField(<span class="st">&quot;User-Agent&quot;</span>, StringType(), <span class="va">True</span>),</a>
<a class="sourceLine" id="cb10-22" data-line-number="22">        StructField(<span class="st">&quot;event_type&quot;</span>, StringType(), <span class="va">True</span>),</a>
<a class="sourceLine" id="cb10-23" data-line-number="23">    ])</a>
<a class="sourceLine" id="cb10-24" data-line-number="24"></a>
<a class="sourceLine" id="cb10-25" data-line-number="25"></a>
<a class="sourceLine" id="cb10-26" data-line-number="26"><span class="at">@udf</span>(<span class="st">&#39;boolean&#39;</span>)</a>
<a class="sourceLine" id="cb10-27" data-line-number="27"><span class="kw">def</span> is_sword_purchase(event_as_json):</a>
<a class="sourceLine" id="cb10-28" data-line-number="28">    <span class="co">&quot;&quot;&quot;udf for filtering events</span></a>
<a class="sourceLine" id="cb10-29" data-line-number="29"><span class="co">    &quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb10-30" data-line-number="30">    event <span class="op">=</span> json.loads(event_as_json)</a>
<a class="sourceLine" id="cb10-31" data-line-number="31">    <span class="cf">if</span> event[<span class="st">&#39;event_type&#39;</span>] <span class="op">==</span> <span class="st">&#39;purchase_sword&#39;</span>:</a>
<a class="sourceLine" id="cb10-32" data-line-number="32">        <span class="cf">return</span> <span class="va">True</span></a>
<a class="sourceLine" id="cb10-33" data-line-number="33">    <span class="cf">return</span> <span class="va">False</span></a>
<a class="sourceLine" id="cb10-34" data-line-number="34"></a>
<a class="sourceLine" id="cb10-35" data-line-number="35"></a>
<a class="sourceLine" id="cb10-36" data-line-number="36"><span class="kw">def</span> main():</a>
<a class="sourceLine" id="cb10-37" data-line-number="37">    <span class="co">&quot;&quot;&quot;main</span></a>
<a class="sourceLine" id="cb10-38" data-line-number="38"><span class="co">    &quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb10-39" data-line-number="39">    spark <span class="op">=</span> SparkSession <span class="op">\</span></a>
<a class="sourceLine" id="cb10-40" data-line-number="40">        .builder <span class="op">\</span></a>
<a class="sourceLine" id="cb10-41" data-line-number="41">        .appName(<span class="st">&quot;ExtractEventsJob&quot;</span>) <span class="op">\</span></a>
<a class="sourceLine" id="cb10-42" data-line-number="42">        .getOrCreate()</a>
<a class="sourceLine" id="cb10-43" data-line-number="43"></a>
<a class="sourceLine" id="cb10-44" data-line-number="44">    raw_events <span class="op">=</span> spark <span class="op">\</span></a>
<a class="sourceLine" id="cb10-45" data-line-number="45">        .readStream <span class="op">\</span></a>
<a class="sourceLine" id="cb10-46" data-line-number="46">        .<span class="bu">format</span>(<span class="st">&quot;kafka&quot;</span>) <span class="op">\</span></a>
<a class="sourceLine" id="cb10-47" data-line-number="47">        .option(<span class="st">&quot;kafka.bootstrap.servers&quot;</span>, <span class="st">&quot;kafka:29092&quot;</span>) <span class="op">\</span></a>
<a class="sourceLine" id="cb10-48" data-line-number="48">        .option(<span class="st">&quot;subscribe&quot;</span>, <span class="st">&quot;events&quot;</span>) <span class="op">\</span></a>
<a class="sourceLine" id="cb10-49" data-line-number="49">        .load()</a>
<a class="sourceLine" id="cb10-50" data-line-number="50"></a>
<a class="sourceLine" id="cb10-51" data-line-number="51">    sword_purchases <span class="op">=</span> raw_events <span class="op">\</span></a>
<a class="sourceLine" id="cb10-52" data-line-number="52">        .<span class="bu">filter</span>(is_sword_purchase(raw_events.value.cast(<span class="st">&#39;string&#39;</span>))) <span class="op">\</span></a>
<a class="sourceLine" id="cb10-53" data-line-number="53">        .select(raw_events.value.cast(<span class="st">&#39;string&#39;</span>).alias(<span class="st">&#39;raw_event&#39;</span>),</a>
<a class="sourceLine" id="cb10-54" data-line-number="54">                raw_events.timestamp.cast(<span class="st">&#39;string&#39;</span>),</a>
<a class="sourceLine" id="cb10-55" data-line-number="55">                from_json(raw_events.value.cast(<span class="st">&#39;string&#39;</span>),</a>
<a class="sourceLine" id="cb10-56" data-line-number="56">                          purchase_sword_event_schema()).alias(<span class="st">&#39;json&#39;</span>)) <span class="op">\</span></a>
<a class="sourceLine" id="cb10-57" data-line-number="57">        .select(<span class="st">&#39;raw_event&#39;</span>, <span class="st">&#39;timestamp&#39;</span>, <span class="st">&#39;json.*&#39;</span>)</a>
<a class="sourceLine" id="cb10-58" data-line-number="58"></a>
<a class="sourceLine" id="cb10-59" data-line-number="59">    sink <span class="op">=</span> sword_purchases <span class="op">\</span></a>
<a class="sourceLine" id="cb10-60" data-line-number="60">        .writeStream <span class="op">\</span></a>
<a class="sourceLine" id="cb10-61" data-line-number="61">        .<span class="bu">format</span>(<span class="st">&quot;parquet&quot;</span>) <span class="op">\</span></a>
<a class="sourceLine" id="cb10-62" data-line-number="62">        .option(<span class="st">&quot;checkpointLocation&quot;</span>, <span class="st">&quot;/tmp/checkpoints_for_sword_purchases&quot;</span>) <span class="op">\</span></a>
<a class="sourceLine" id="cb10-63" data-line-number="63">        .option(<span class="st">&quot;path&quot;</span>, <span class="st">&quot;/tmp/sword_purchases&quot;</span>) <span class="op">\</span></a>
<a class="sourceLine" id="cb10-64" data-line-number="64">        .trigger(processingTime<span class="op">=</span><span class="st">&quot;120 seconds&quot;</span>) <span class="op">\</span></a>
<a class="sourceLine" id="cb10-65" data-line-number="65">        .start()</a>
<a class="sourceLine" id="cb10-66" data-line-number="66"></a>
<a class="sourceLine" id="cb10-67" data-line-number="67">    sink.awaitTermination()</a>
<a class="sourceLine" id="cb10-68" data-line-number="68"></a>
<a class="sourceLine" id="cb10-69" data-line-number="69"></a>
<a class="sourceLine" id="cb10-70" data-line-number="70"><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&quot;__main__&quot;</span>:</a>
<a class="sourceLine" id="cb10-71" data-line-number="71">    main()</a></code></pre></div>
<aside class="notes">
<ul>
<li>same as last week except <code>processingTime</code></li>
<li>Also 120 second window</li>
</ul>
</aside>
</section>
<section id="run-it" class="level2">
<h2>Run it</h2>
<pre><code>docker-compose exec spark spark-submit /w205/full-streaming-stack/write_swords_stream.py</code></pre>
<aside class="notes">
<p>wait a bit for the first stream interval to finish saving data</p>
</aside>
</section>
<section id="check-what-it-wrote-to-hadoop" class="level2">
<h2>Check what it wrote to Hadoop</h2>
<pre><code>docker-compose exec cloudera hadoop fs -ls /tmp/sword_purchases</code></pre>
<aside class="notes">

</aside>
</section>
</section>
<section id="section-8" class="slide level1">
<h1></h1>
<section id="set-up-presto" class="level2">
<h2>Set up Presto</h2>
</section>
<section id="hive-metastore" class="level2">
<h2>Hive metastore</h2>
<pre><code>docker-compose exec cloudera hive</code></pre>
<aside class="notes">
<ul>
<li>Run hive in the hadoop container</li>
<li>This is what you would do, donâ€™t need to actually do it, skip to easier way</li>
</ul>
</aside>
</section>
<section id="section-9" class="level2">
<h2></h2>
<div class="sourceCode" id="cb14"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="kw">create</span> external <span class="kw">table</span> <span class="kw">if</span> <span class="kw">not</span> <span class="kw">exists</span> default.sword_purchases (</a>
<a class="sourceLine" id="cb14-2" data-line-number="2">    Accept string,</a>
<a class="sourceLine" id="cb14-3" data-line-number="3">    Host string,</a>
<a class="sourceLine" id="cb14-4" data-line-number="4">    User_Agent string,</a>
<a class="sourceLine" id="cb14-5" data-line-number="5">    event_type string,</a>
<a class="sourceLine" id="cb14-6" data-line-number="6">    <span class="dt">timestamp</span> string,</a>
<a class="sourceLine" id="cb14-7" data-line-number="7">    raw_event string</a>
<a class="sourceLine" id="cb14-8" data-line-number="8">  )</a>
<a class="sourceLine" id="cb14-9" data-line-number="9">  stored <span class="kw">as</span> parquet </a>
<a class="sourceLine" id="cb14-10" data-line-number="10">  location <span class="st">&#39;/tmp/sword_purchases&#39;</span></a>
<a class="sourceLine" id="cb14-11" data-line-number="11">  tblproperties (<span class="ot">&quot;parquet.compress&quot;</span>=<span class="ot">&quot;SNAPPY&quot;</span>);</a></code></pre></div>
<aside class="notes">
<pre><code>create external table if not exists default.sword_purchases (Accept string, Host string, User_Agent string, event_type string, timestamp string, raw_event string) stored as parquet location &#39;/tmp/sword_purchases&#39;  tblproperties (&quot;parquet.compress&quot;=&quot;SNAPPY&quot;);</code></pre>
<p>and then <code>ctrl-D</code> to exit the hive shell</p>
<p>Note: you might browse the metastore in hueâ€¦ <code>open http://localhost:8888/</code> (login/pw is <code>cloudera/cloudera</code>)</p>
</aside>
</section>
<section id="query-this-with-presto" class="level2">
<h2>Query this with presto</h2>
<pre><code>docker-compose exec presto presto --server presto:8080 --catalog hive --schema default</code></pre>
</section>
<section id="what-tables-do-we-have-in-presto" class="level2">
<h2>What tables do we have in Presto?</h2>
<pre><code>presto:default&gt; show tables;</code></pre>
</section>
<section id="describe-sword_purchases-table" class="level2">
<h2>Describe <code>sword_purchases</code> table</h2>
<pre><code>presto:default&gt; describe sword_purchases;</code></pre>
</section>
<section id="query-purchases-table" class="level2">
<h2>Query <code>purchases</code> table</h2>
<pre><code>presto:default&gt; select * from sword_purchases;</code></pre>
</section>
</section>
<section id="section-10" class="slide level1">
<h1></h1>
<section id="add-some-data" class="level2">
<h2>Add some data</h2>
</section>
<section id="seed-a-little-data-into-the-stream" class="level2">
<h2>Seed a little data into the stream</h2>
<pre><code>docker-compose exec mids \
  ab \
    -n 10 \
    -H &quot;Host: user1.comcast.com&quot; \
    http://localhost:5000/</code></pre>
<pre><code>docker-compose exec mids \
  ab \
    -n 10 \
    -H &quot;Host: user1.comcast.com&quot; \
    http://localhost:5000/purchase_a_sword</code></pre>
<pre><code>docker-compose exec mids \
  ab \
    -n 10 \
    -H &quot;Host: user2.att.com&quot; \
    http://localhost:5000/</code></pre>
<pre><code>docker-compose exec mids \
  ab \
    -n 10 \
    -H &quot;Host: user2.att.com&quot; \
    http://localhost:5000/purchase_a_sword</code></pre>
<aside class="notes">
<ul>
<li>Will pump more events through once streaming is running</li>
</ul>
<pre><code>docker-compose exec mids ab -n 10 -H &quot;Host: user1.comcast.com&quot; http://localhost:5000/
docker-compose exec mids ab -n 10 -H &quot;Host: user1.comcast.com&quot; http://localhost:5000/purchase_a_sword
docker-compose exec mids ab -n 10 -H &quot;Host: user2.att.com&quot; http://localhost:5000/
docker-compose exec mids ab -n 10 -H &quot;Host: user2.att.com&quot; http://localhost:5000/purchase_a_sword</code></pre>
</aside>
</section>
<section id="query-purchases-table-1" class="level2">
<h2>Query <code>purchases</code> table</h2>
<pre><code>presto:default&gt; select * from sword_purchases;</code></pre>
<aside class="notes">
<p>wait a stream cycle for data to be ingested</p>
</aside>
</section>
</section>
<section id="section-11" class="slide level1">
<h1></h1>
<section id="more-data" class="level2">
<h2>More data</h2>
</section>
<section id="feed-the-stream-more-data" class="level2">
<h2>Feed the stream more data</h2>
<pre><code>while true; do
  docker-compose exec mids \
    ab -n 10 -H &quot;Host: user1.comcast.com&quot; \
      http://localhost:5000/purchase_a_sword
  sleep 10
done</code></pre>
<aside class="notes">
<pre><code>while true; do docker-compose exec mids ab -n 10 -H &quot;Host: user1.comcast.com&quot; http://localhost:5000/purchase_a_sword; sleep 10; done</code></pre>
</aside>
</section>
<section id="watch-presto-grow" class="level2">
<h2>Watch presto grow</h2>
<pre><code>presto:default&gt; select count(*) from sword_purchases;</code></pre>
<aside class="notes">
<p>remember, thereâ€™s a two minute stream interval</p>
<p>Note: you might run hive directly from hueâ€¦ <code>open http://localhost:8888/</code> (login/pw is <code>cloudera/cloudera</code>). We recommend Presto as a much better query option in general, but hue has its uses.</p>
<p>for cloud instances, <code>s/localhost/&lt;cloud_instance_ip&gt;/</code> - hue can be used as a gui to browse the hdfs file directory, can upload and download files, change permissions, a lot of complications with hdfs are about permissions, so this easy access to whatâ€™s up can be really helpful. - Thatâ€™s why weâ€™ve been writing to the tmp directory is to avoid dealing with permissions for this class. - can also do a query editor in hue - e.g., select * from default.sword_purchases. - hive will try to kick off a bunch of map reduce jobs under the hood, and we havenâ€™t set up the resources to handle that. - therefore, Presto is better.</p>
</aside>
</section>
</section>
<section id="section-12" class="slide level1">
<h1></h1>
<section id="down" class="level2">
<h2>down</h2>
<pre><code>docker-compose down</code></pre>
<aside class="notes">

</aside>
</section>
</section>
<section id="section-13" class="slide level1">
<h1></h1>
<section id="section-14" class="level2" data-background="images/pipeline-steel-thread-for-mobile-app.svg">
<h2></h2>
</section>
</section>
<section id="section-15" class="slide level1">
<h1></h1>
<section id="building-docker-images" class="level2">
<h2>Building Docker Images</h2>
</section>
<section id="setup-1" class="level2">
<h2>Setup</h2>
<pre><code>mkdir -p ~/w205/docker/mytools
cd ~/w205/docker/mytools</code></pre>
<aside class="notes">
<p>letâ€™s create a little workspace</p>
</aside>
</section>
<section id="the-dockerfile" class="level2">
<h2>The <code>Dockerfile</code></h2>
<p>Save this as <code>Dockerfile</code> in <code>~/w205/docker/mytools/</code></p>
<div class="sourceCode" id="cb31"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><a class="sourceLine" id="cb31-1" data-line-number="1"><span class="kw">FROM</span> ubuntu:xenial</a>
<a class="sourceLine" id="cb31-2" data-line-number="2"><span class="kw">MAINTAINER</span> Mark Mims &lt;mark@digitalocean.com&gt;</a>
<a class="sourceLine" id="cb31-3" data-line-number="3"></a>
<a class="sourceLine" id="cb31-4" data-line-number="4"><span class="kw">RUN</span> apt-get -qq update \</a>
<a class="sourceLine" id="cb31-5" data-line-number="5">  &amp;&amp; apt-get -qq install -y jq apache2-utils</a></code></pre></div>
<aside class="notes">
<p>rules to build docker imagesâ€¦ weâ€™ll see more examples below</p>
</aside>
</section>
<section id="build" class="level2">
<h2>Build</h2>
<pre><code>docker build -t &lt;tag&gt; &lt;path&gt;</code></pre>
<p>so, from a folder containing a <code>Dockerfile</code>,</p>
<pre><code>docker build -t mytools .</code></pre>
<aside class="notes">
<p>weâ€™ve gone over <code>.</code> before, but reiterate</p>
<p>also, tag can include namespace and versionsâ€¦ - <code>mytools</code> is implicitly <code>mytools:latest</code> - <code>mytools:0.0.1</code> or <code>mytools:some-string-here</code> - <code>markmims/mytools:0.0.1</code> or <code>midsw205/mytools:0.0.1</code></p>
<ul>
<li>Need to tag mytools, fix permissions to do this</li>
<li><code>docker images | grep mytools</code></li>
</ul>
</aside>
</section>
<section id="check-build-ids-and-tags" class="level2">
<h2>check build ids and tags</h2>
<pre><code>docker images | grep mytools</code></pre>
</section>
<section id="test-a-build" class="level2">
<h2>test a build</h2>
<pre><code>docker run -it --rm mytools bash</code></pre>
<p>then at the prompt</p>
<pre><code>which jq</code></pre>
<aside class="notes">
<ul>
<li>show with <code>which jq</code> that the container we built is different than the ubuntu base container <code>exit</code> or <code>ctl-d</code> to get out of the container after running this command</li>
</ul>
</aside>
</section>
<section id="what-did-we-do" class="level2">
<h2>What did we do?</h2>
<pre><code>docker run -it --rm ubuntu:xenial which jq
docker run -it --rm mytools which jq</code></pre>
<aside class="notes">
<p>bare <code>ubuntu</code> doesnâ€™t have <code>jq</code>, but ours does now</p>
</aside>
</section>
<section id="iterate" class="level2">
<h2>Iterate</h2>
</section>
<section id="you-can-do-more-in-a-dockerfile" class="level2">
<h2>You can do more in a <code>Dockerfile</code></h2>
<div class="sourceCode" id="cb38"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><a class="sourceLine" id="cb38-1" data-line-number="1"><span class="kw">FROM</span> ubuntu:16.04</a>
<a class="sourceLine" id="cb38-2" data-line-number="2"><span class="kw">MAINTAINER</span> Mark Mims &lt;mark@digitalocean.com&gt;</a>
<a class="sourceLine" id="cb38-3" data-line-number="3"></a>
<a class="sourceLine" id="cb38-4" data-line-number="4"><span class="kw">ENV</span> SPARK_VERSION        2.2.0</a>
<a class="sourceLine" id="cb38-5" data-line-number="5"><span class="kw">ENV</span> SPARK_HADOOP_VERSION 2.6</a>
<a class="sourceLine" id="cb38-6" data-line-number="6"></a>
<a class="sourceLine" id="cb38-7" data-line-number="7"><span class="kw">ENV</span> SPARK_HOME /spark-$SPARK_VERSION-bin-hadoop$SPARK_HADOOP_VERSION</a>
<a class="sourceLine" id="cb38-8" data-line-number="8"><span class="kw">ENV</span> JAVA_HOME  /usr/lib/jvm/java-8-oracle</a>
<a class="sourceLine" id="cb38-9" data-line-number="9"></a>
<a class="sourceLine" id="cb38-10" data-line-number="10"><span class="kw">ENV</span> SPARK_TEMPLATE_PATH $SPARK_HOME/templates</a>
<a class="sourceLine" id="cb38-11" data-line-number="11"><span class="kw">ENV</span> SPARK_CONF_PATH $SPARK_HOME/conf</a>
<a class="sourceLine" id="cb38-12" data-line-number="12"></a>
<a class="sourceLine" id="cb38-13" data-line-number="13"><span class="kw">ENV</span> PATH $SPARK_HOME/bin:$PATH</a>
<a class="sourceLine" id="cb38-14" data-line-number="14"></a>
<a class="sourceLine" id="cb38-15" data-line-number="15"><span class="kw">RUN</span> echo oracle-java8-installer shared/accepted-oracle-license-v1-1 select true | debconf-set-selections \</a>
<a class="sourceLine" id="cb38-16" data-line-number="16">  &amp;&amp; apt-get update \</a>
<a class="sourceLine" id="cb38-17" data-line-number="17">  &amp;&amp; apt-get upgrade -y \</a>
<a class="sourceLine" id="cb38-18" data-line-number="18">  &amp;&amp; apt-get install -y software-properties-common \</a>
<a class="sourceLine" id="cb38-19" data-line-number="19">  &amp;&amp; add-apt-repository -y ppa:webupd8team/java \</a>
<a class="sourceLine" id="cb38-20" data-line-number="20">  &amp;&amp; apt-key adv --keyserver keyserver.ubuntu.com --recv E56151BF \</a>
<a class="sourceLine" id="cb38-21" data-line-number="21">  &amp;&amp; apt-get update \</a>
<a class="sourceLine" id="cb38-22" data-line-number="22">  &amp;&amp; apt-get install -y \</a>
<a class="sourceLine" id="cb38-23" data-line-number="23">      curl \</a>
<a class="sourceLine" id="cb38-24" data-line-number="24">      dnsutils \</a>
<a class="sourceLine" id="cb38-25" data-line-number="25">      oracle-java8-installer \</a>
<a class="sourceLine" id="cb38-26" data-line-number="26">  &amp;&amp; apt-get purge -y software-properties-common \</a>
<a class="sourceLine" id="cb38-27" data-line-number="27">  &amp;&amp; apt-get autoremove -y \</a>
<a class="sourceLine" id="cb38-28" data-line-number="28">  &amp;&amp; curl -OL http://www-us.apache.org/dist/spark/spark-$SPARK_VERSION/spark-$SPARK_VERSION-bin-hadoop$SPARK_HADOOP_VERSION.tgz \</a>
<a class="sourceLine" id="cb38-29" data-line-number="29">  &amp;&amp; tar xf spark-$SPARK_VERSION-bin-hadoop$SPARK_HADOOP_VERSION.tgz \</a>
<a class="sourceLine" id="cb38-30" data-line-number="30">  &amp;&amp; rm spark-$SPARK_VERSION-bin-hadoop$SPARK_HADOOP_VERSION.tgz</a>
<a class="sourceLine" id="cb38-31" data-line-number="31"></a>
<a class="sourceLine" id="cb38-32" data-line-number="32"><span class="kw">COPY</span> *-site.xml            $SPARK_TEMPLATE_PATH/</a>
<a class="sourceLine" id="cb38-33" data-line-number="33"><span class="kw">COPY</span> *.properties          $SPARK_CONF_PATH/</a>
<a class="sourceLine" id="cb38-34" data-line-number="34"><span class="kw">COPY</span> spark-defaults.conf   $SPARK_CONF_PATH</a>
<a class="sourceLine" id="cb38-35" data-line-number="35"><span class="kw">COPY</span> spark-env.sh          $SPARK_CONF_PATH</a>
<a class="sourceLine" id="cb38-36" data-line-number="36"></a>
<a class="sourceLine" id="cb38-37" data-line-number="37"><span class="kw">COPY</span> jars/* $SPARK_HOME/jars/</a>
<a class="sourceLine" id="cb38-38" data-line-number="38"></a>
<a class="sourceLine" id="cb38-39" data-line-number="39"><span class="kw">WORKDIR</span> $SPARK_HOME</a>
<a class="sourceLine" id="cb38-40" data-line-number="40"></a>
<a class="sourceLine" id="cb38-41" data-line-number="41"><span class="kw">COPY</span> docker-entrypoint.sh /usr/local/bin/</a>
<a class="sourceLine" id="cb38-42" data-line-number="42"><span class="kw">RUN</span> ln -s usr/local/bin/docker-entrypoint.sh entrypoint.sh</a>
<a class="sourceLine" id="cb38-43" data-line-number="43"><span class="kw">ENTRYPOINT</span> [<span class="st">&quot;docker-entrypoint.sh&quot;</span>]</a>
<a class="sourceLine" id="cb38-44" data-line-number="44"><span class="kw">CMD</span> [<span class="st">&quot;spark-shell&quot;</span>]</a></code></pre></div>
<aside class="notes">
<ul>
<li><p>this is our <code>midsw205/spark-minimal</code> docker image</p></li>
<li>note some of the primitives:</li>
<li><code>ENV</code></li>
<li><code>RUN</code></li>
<li><code>COPY</code></li>
<li><p><code>CMD</code></p></li>
<li><p>show that it starts a spark shell (focus on <code>CMD</code> &amp; <code>RUN</code>)</p></li>
<li>Perhaps discuss chaining images.. i.e., use <code>FROM openjdk:8</code> instead of installing java the way we do here</li>
</ul>
</aside>
</section>
<section id="examples-of-different-dockerfiles" class="level2">
<h2>Examples of different <code>Dockerfile</code>s</h2>
<ul>
<li><a href="https://github.com/docker-library/nginx/blob/master/1.7/Dockerfile">nginx</a></li>
<li><a href="https://github.com/docker-library/mongo/blob/master/3.7/Dockerfile">mongo</a></li>
<li><a href="https://github.com/docker-library/mysql/blob/master/8.0/Dockerfile">mysql</a></li>
<li><a href="https://github.com/docker-library/python/blob/master/3.6/jessie/Dockerfile">python</a></li>
<li><a href="https://github.com/docker-library/">etcâ€¦</a></li>
</ul>
<aside class="notes">
<ul>
<li>Check out docker hub (hub.docker.com)</li>
<li>search for e.g., mongo etc, see how many there are</li>
<li>any big open source project is likely to have an image on docker hub</li>
<li>also great place to see examples of Dockerfiles</li>
<li>What is the process, you can keep images around - you only need to build once until you change it.</li>
<li>Then you spin up containers from them.</li>
<li>(show could do RUNâ€¦ then another RUNâ€¦) but that would be bloated. These files start wiht one image and they layer other file systems on top of it. Try to be efficient. Every RUN command is another file system layer. Trying to make each layer as minimal and efficient as possible.</li>
<li>Our main image does not follow these guidelines :)</li>
<li>Check out <a href="https://docs.docker.com/compose/gettingstarted/" class="uri">https://docs.docker.com/compose/gettingstarted/</a> for a good example of integrating a container you <em>build</em> into a cluster of containers.</li>
</ul>
</aside>
</section>
</section>
<section id="section-16" class="slide level1">
<h1></h1>
<p><img class="logo" src="images/berkeley-school-of-information-logo.png"/></p>
</section>
    </div>
  </div>

  <script src="reveal.js/lib/js/head.min.js"></script>
  <script src="reveal.js/js/reveal.js"></script>

  <script>

      // Full list of configuration options available at:
      // https://github.com/hakimel/reveal.js#configuration
      Reveal.initialize({
        // Transition style
        transition: 'linear', // none/fade/slide/convex/concave/zoom

        math: {
          config: 'TeX-AMS_HTML-full'
        },

        // Optional reveal.js plugins
        dependencies: [
          { src: 'reveal.js/lib/js/classList.js', condition: function() { return !document.body.classList; } },
          { src: 'reveal.js/plugin/zoom-js/zoom.js', async: true },
          { src: 'reveal.js/plugin/notes/notes.js', async: true },
          { src: 'reveal.js/plugin/math/math.js', async: true }
        ]
      });
    </script>
    </body>
</html>
